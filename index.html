<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material You Music Player</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- jsmediatags library for reading metadata -->
    <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
    <style>
        :root {
            --background-color: #0B111E;
            --surface-color: #161E2C;
            --on-surface-color: #F9FAFB;
            --primary-accent: #0891B2; /* cyan-600 */
            --primary-accent-darker: #0E7490; /* cyan-700 */
            --secondary-text: #9CA3AF; /* gray-400 */
            --card-background: #1F2937;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--on-surface-color);
        }

        /* Custom scrollbar for a more integrated feel */
        .playlist::-webkit-scrollbar {
            width: 8px;
        }
        .playlist::-webkit-scrollbar-track {
            background: var(--surface-color);
            border-radius: 10px;
        }
        .playlist::-webkit-scrollbar-thumb {
            background-color: var(--primary-accent);
            border-radius: 10px;
            border: 2px solid var(--surface-color);
        }
    </style>
</head>
<body class="flex items-center justify-center">

    <div class="max-w-sm w-full h-screen flex flex-col bg-background-color">

        <!-- Header -->
        <header class="p-6 flex justify-between items-center">
            <h1 class="text-4xl font-bold text-white">Library</h1>
            <button id="settings-btn" class="text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                    <title>cog</title>
                    <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                </svg>
            </button>
        </header>

        <!-- Tabs -->
        <div class="px-6 mb-4">
            <div class="flex space-x-2">
                <button class="flex-1 py-2 px-4 rounded-full text-sm font-semibold bg-primary-accent text-white">SONGS</button>
                <button class="flex-1 py-2 px-4 rounded-full text-sm font-semibold bg-card-background text-white">ALBUMS</button>
                <button class="flex-1 py-2 px-4 rounded-full text-sm font-semibold bg-card-background text-white">ARTIST</button>
                <button class="flex-1 py-2 px-4 rounded-full text-sm font-semibold bg-card-background text-white">PLAYLISTS</button>
            </div>
        </div>

        <!-- Main Content -->
        <main class="relative flex-1 overflow-y-auto px-6 space-y-4 bg-surface-color rounded-t-3xl">
            <div class="pt-6 flex items-center justify-between">
                <button id="shuffle-btn" class="flex items-center space-x-2 bg-primary-accent-darker text-white py-2 px-5 rounded-full font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shuffle"><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l6.1-8.6c.7-1.1 2-1.7 3.3-1.7H22"/><path d="m18 2 4 4-4 4"/><path d="M2 6h1.4c1.3 0 2.5.6 3.3 1.7l2.1 3 2.1 3c.7 1.1 2 1.7 3.3 1.7H22"/><path d="m18 22 4-4-4-4"/></svg>
                    <span>Shuffle</span>
                </button>
                <button id="sort-btn" class="text-white p-2 rounded-full bg-card-background">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" x2="21" y1="12" y2="12"/><line x1="3" x2="21" y1="6" y2="6"/><line x1="3" x2="21" y1="18" y2="18"/></svg>
                </button>
            </div>

            <!-- Sort Menu -->
            <div id="sort-menu" class="absolute right-6 top-16 bg-card-background p-2 rounded-lg shadow-lg space-y-1 hidden">
                <button id="sort-by-album" class="w-full text-left px-4 py-2 text-sm hover:bg-surface-color rounded">Sort by Album</button>
                <button id="sort-by-artist" class="w-full text-left px-4 py-2 text-sm hover:bg-surface-color rounded">Sort by Artist</button>
            </div>

            <!-- Playlist -->
            <div id="playlist" class="playlist space-y-2 pb-24">
                <!-- Playlist items will be injected here by JavaScript -->
            </div>
        </main>

        <!-- Now Playing Bar -->
        <div id="now-playing-bar" class="fixed bottom-20 left-0 right-0 max-w-sm mx-auto p-3 bg-card-background/90 backdrop-blur-sm rounded-xl hidden">
            <div id="progress-bar-container" class="w-full h-1 bg-gray-600 rounded-full cursor-pointer mb-2">
                <div id="progress-bar" class="h-1 bg-primary-accent rounded-full" style="width: 0%;"></div>
            </div>
            <div class="flex items-center space-x-4">
                <img id="now-playing-art" src="" alt="Album Art" class="w-10 h-10 rounded-md">
                <div class="flex-1 overflow-hidden">
                    <p id="now-playing-title" class="text-sm font-semibold text-on-surface-color truncate">Song Title</p>
                    <p id="now-playing-artist" class="text-xs text-secondary-text truncate">Artist</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="prev-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-step-back"><line x1="18" x2="18" y1="20" y2="4"/><polygon points="14,20 4,12 14,4"/></svg>
                    </button>
                    <button id="play-pause-btn">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play-circle"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>
                        <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause-circle hidden"><circle cx="12" cy="12" r="10"/><line x1="10" x2="10" y1="15" y2="9"/><line x1="14" x2="14" y1="15" y2="9"/></svg>
                    </button>
                    <button id="next-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-step-forward"><line x1="6" x2="6" y1="4" y2="20"/><polygon points="10,4 20,12 10,20"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-sm mx-auto p-4 bg-card-background/80 backdrop-blur-sm">
            <div class="flex justify-around items-center">
                <button class="flex flex-col items-center space-y-1 text-secondary-text">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    <span class="text-xs">Home</span>
                </button>
                <button class="flex flex-col items-center space-y-1 text-secondary-text">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    <span class="text-xs">Search</span>
                </button>
                <button class="flex flex-col items-center space-y-1 text-primary-accent">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <title>music</title>
                        <path d="M21,3V15.5A3.5,3.5 0 0,1 17.5,19A3.5,3.5 0 0,1 14,15.5A3.5,3.5 0 0,1 17.5,12C18.04,12 18.55,12.12 19,12.34V6.47L9,8.6V17.5A3.5,3.5 0 0,1 5.5,21A3.5,3.5 0 0,1 2,17.5A3.5,3.5 0 0,1 5.5,14C6.04,14 6.55,14.12 7,14.34V6L21,3Z" />
                    </svg>
                    <span class="text-xs font-bold">Library</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-card-background p-6 rounded-2xl shadow-lg w-11/12 max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Settings</h2>
                <button id="close-modal-btn" class="text-white">&times;</button>
            </div>
            <div class="space-y-4">
                <button id="import-btn" class="w-full bg-primary-accent text-white py-3 px-4 rounded-lg font-semibold">Import Files</button>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" class="hidden" multiple accept="audio/*,video/mp4">

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let songs = [];
            let currentSort = 'default';

            // DOM Elements
            const audio = new Audio();
            const playlistElement = document.getElementById('playlist');
            const shuffleBtn = document.getElementById('shuffle-btn');
            const fileInput = document.getElementById('file-input');
            const nowPlayingBar = document.getElementById('now-playing-bar');
            const progressBar = document.getElementById('progress-bar');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const nowPlayingArt = document.getElementById('now-playing-art');
            const nowPlayingTitle = document.getElementById('now-playing-title');
            const nowPlayingArtist = document.getElementById('now-playing-artist');
            const prevBtn = document.getElementById('prev-btn');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const nextBtn = document.getElementById('next-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const sortBtn = document.getElementById('sort-btn');
            const sortMenu = document.getElementById('sort-menu');
            const sortByAlbumBtn = document.getElementById('sort-by-album');
            const sortByArtistBtn = document.getElementById('sort-by-artist');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const importBtn = document.getElementById('import-btn');

            // Player State
            let currentSongIndex = 0;
            let isPlaying = false;

            // Helper function to convert album art from tags to a data URL
            function getAlbumArtURL(picture) {
                if (!picture || !picture.data || !picture.format) {
                    // A default placeholder image
                    return 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLW11c2ljIj48cGF0aCBkPSJNOSAxOHYtNVMyMSAyIDEyIDJ2MTMiLz48Y2lyY2xlIGN4PSI2IiBjeT0iMTgiIHI9IjMiLz48Y2lyY2xlIGN4PSIxOCIgY3k9IjE2IiByPSIzIi8+PC9zdmc+';
                }
                const base64String = btoa(String.fromCharCode.apply(null, picture.data));
                return `data:${picture.format};base64,${base64String}`;
            }

            // Function to load a song
            function loadSong(songIndex) {
                if (songIndex >= 0 && songIndex < songs.length) {
                    const song = songs[songIndex];
                    audio.src = song.src;
                    nowPlayingArt.src = song.albumArt;
                    nowPlayingTitle.textContent = song.title;
                    nowPlayingArtist.textContent = song.artist;
                    currentSongIndex = songIndex;
                    updatePlaylistUI();
                    nowPlayingBar.classList.remove('hidden');
                }
            }

            // Function to play or pause the current song
            function playPauseSong() {
                if (songs.length === 0) return;
                if (isPlaying) {
                    audio.pause();
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                } else {
                    audio.play();
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                }
                isPlaying = !isPlaying;
                updatePlaylistUI();
            }

            // Function to play the next song
            function nextSong() {
                if (songs.length === 0) return;
                const nextIndex = (currentSongIndex + 1) % songs.length;
                loadSong(nextIndex);
                audio.play();
                isPlaying = true;
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            }

            // Function to play the previous song
            function prevSong() {
                if (songs.length === 0) return;
                const prevIndex = (currentSongIndex - 1 + songs.length) % songs.length;
                loadSong(prevIndex);
                audio.play();
                isPlaying = true;
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            }

            // Update the progress bar as the song plays
            function updateProgress() {
                if (!isNaN(audio.duration)) {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    progressBar.style.width = `${progress}%`;
                }
            }

            // Seek to a new position in the song
            function seek(event) {
                if (!isNaN(audio.duration)) {
                    const width = this.clientWidth;
                    const clickX = event.offsetX;
                    const duration = audio.duration;
                    audio.currentTime = (clickX / width) * duration;
                }
            }

            // Generate the playlist UI based on the current songs array
            function renderPlaylist() {
                playlistElement.innerHTML = '';
                if (songs.length === 0) {
                    playlistElement.innerHTML = `<p class="text-center text-secondary-text mt-8">Click Shuffle to add songs.</p>`;
                    return;
                }
                songs.forEach((song, index) => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center p-3 rounded-lg cursor-pointer bg-card-background space-x-4';

                    const playingClass = (index === currentSongIndex) ? 'border-2 border-primary-accent' : '';
                    const textColor = (index === currentSongIndex) ? 'text-primary-accent' : 'text-on-surface-color';

                    item.innerHTML = `
                        <img src="${song.albumArt}" alt="${song.title} album art" class="w-12 h-12 rounded-md object-cover ${playingClass}">
                        <div class="flex-1 overflow-hidden">
                            <h3 class="text-base font-semibold truncate ${textColor}">${song.title}</h3>
                            <p class="text-sm text-secondary-text truncate">${song.artist}</p>
                        </div>
                        <button class="text-secondary-text hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                        </button>
                    `;
                    item.addEventListener('click', () => {
                        // If it's the same song, toggle play/pause. Otherwise, load and play new song.
                        if (index === currentSongIndex) {
                            playPauseSong();
                        } else {
                            loadSong(index);
                            audio.play();
                            isPlaying = true;
                        }
                    });
                    playlistElement.appendChild(item);
                });
            }

            // Update the UI to show which song is currently active
            function updatePlaylistUI() {
                const playlistItems = playlistElement.querySelectorAll('.flex.items-center');
                playlistItems.forEach((item, index) => {
                    const img = item.querySelector('img');
                    const title = item.querySelector('h3');
                    if (index === currentSongIndex) {
                        img.classList.add('border-2', 'border-primary-accent');
                        title.classList.add('text-primary-accent');
                        title.classList.remove('text-on-surface-color');
                    } else {
                        img.classList.remove('border-2', 'border-primary-accent');
                        title.classList.remove('text-primary-accent');
                        title.classList.add('text-on-surface-color');
                    }
                });
            }

            // Shuffle the current playlist
            function shufflePlaylist() {
                if (songs.length < 2) return;

                // Standard Fisher-Yates shuffle algorithm
                for (let i = songs.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [songs[i], songs[j]] = [songs[j], songs[i]];
                }

                // After shuffling, re-render the playlist and load the first song
                currentSongIndex = 0;
                isPlaying = false;
                audio.pause();
                renderPlaylist();
                loadSong(0);
            }

            // Logic for adding new files and reading metadata
            shuffleBtn.addEventListener('click', () => {
                if (songs.length > 0) {
                    shufflePlaylist();
                } else {
                    fileInput.click();
                }
            });

            settingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
            });

            closeModalBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });

            importBtn.addEventListener('click', () => {
                fileInput.click();
                settingsModal.classList.add('hidden');
            });

            fileInput.addEventListener('change', async (event) => {
                const files = event.target.files;
                if (files.length > 0) {
                    const newSongs = [];
                    for (const file of files) {
                        try {
                            const tags = await new Promise((resolve, reject) => {
                                new jsmediatags(file).read({
                                    onSuccess: resolve,
                                    onError: reject
                                });
                            });
                            
                            const picture = tags.tags.picture;
                            const albumArtUrl = getAlbumArtURL(picture);

                            newSongs.push({
                                title: tags.tags.title || file.name.split('.').slice(0, -1).join('.'),
                                artist: tags.tags.artist || "Unknown Artist",
                                album: tags.tags.album || "Unknown Album",
                                albumArt: albumArtUrl,
                                src: URL.createObjectURL(file)
                            });
                        } catch (error) {
                            console.error("Error reading file metadata:", error);
                            // Fallback if metadata reading fails
                            newSongs.push({
                                title: file.name.split('.').slice(0, -1).join('.'),
                                artist: "Unknown Artist",
                                album: "Unknown Album",
                                albumArt: getAlbumArtURL(null), // Use default art
                                src: URL.createObjectURL(file)
                            });
                        }
                    }

                    if (newSongs.length > 0) {
                        songs.push(...newSongs);
                        renderPlaylist();
                        // If this is the first batch of songs, load the first one and set a consistent initial state.
                        if (songs.length === newSongs.length) {
                             loadSong(0);
                             isPlaying = false;
                             playIcon.classList.remove('hidden');
                             pauseIcon.classList.add('hidden');
                        }
                    }
                }
            });

            // Player Event Listeners
            prevBtn.addEventListener('click', prevSong);
            playPauseBtn.addEventListener('click', playPauseSong);
            nextBtn.addEventListener('click', nextSong);
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', nextSong);
            progressBarContainer.addEventListener('click', seek);

            // Sort menu logic
            sortBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                sortMenu.classList.toggle('hidden');
            });

            sortByAlbumBtn.addEventListener('click', () => {
                if (songs.length > 0) {
                    songs.sort((a, b) => a.album.localeCompare(b.album));
                    renderPlaylist();
                    sortMenu.classList.add('hidden');
                }
            });

            sortByArtistBtn.addEventListener('click', () => {
                if (songs.length > 0) {
                    songs.sort((a, b) => a.artist.localeCompare(b.artist));
                    renderPlaylist();
                    sortMenu.classList.add('hidden');
                }
            });

            // Hide sort menu if clicking outside
            document.addEventListener('click', (e) => {
                if (!sortMenu.contains(e.target) && !sortBtn.contains(e.target)) {
                    sortMenu.classList.add('hidden');
                }
            });

            // Initial setup
            renderPlaylist();
        });
    </script>
</body>
</html>